AWSTemplateFormatVersion: '2010-09-09'
Description: >
  AWS ParallelCluster on 2 availability zones

Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Active Directory"
        Parameters: 
          - AdDomainName
          - AdDomainAddr
          - AdDomainReadOnlyUser
          - AdPasswordSecretArn
      - 
        Label: 
          default: "Amazon Elastic Filesystem"
        Parameters: 
          - EfsFilesystemId
      - 
        Label: 
          default: "Head Node"
        Parameters: 
          - OS
          - KeyName
          - HeadNodeSubnetId
      - 
        Label: 
          default: "Compute Nodes and Queues"
        Parameters: 
          - ComputeSubnetIds
          - ComputeInstanceMax
          - GpuComputeInstanceMax
          - MaximumJobDuration
          - ComputeInstanceRetentionTime
      - 
        Label: 
          default: "Miscellaneous"
        Parameters: 
          - ParallelClusterVersion
          - SourceBucket
    ParameterLabels: 
      AdDomainName: 
        default: "Outputs/DomainName"
      AdDomainAddr: 
        default: "Outputs/DomainAddr"
      AdDomainReadOnlyUser: 
        default: "Outputs/DomainReadOnlyUser"
      AdPasswordSecretArn: 
        default: "Outputs/PasswordSecretArn"
      EfsFilesystemId:
        default: "Outputs/EfsFilesystemId"

Parameters:
  ParallelClusterVersion:
    Description: Version of AWS ParallelCluster to use
    Type: String
    Default: 3.6.1

  SourceBucket:
    Description: Bucket to pull recipe templates from
    Type: String
    Default: cfn3-dev-mwvaughn
    NoEcho: true

  # ClusterName:
  #   Description: Name of cluster. Note this must be different than the stack name.
  #   Type: String
  #   Default: tutorial

  ComputeInstanceMax:
    Description: Maximum number of CPU-only instances in the queue(s)
    Type: Number
    Default: 16

  GpuComputeInstanceMax:
    Description: Maximum number of GPU instances in the queue(s)
    Type: Number
    Default: 16

  MaximumJobDuration:
    Description: The longest a user job is allowed to run (hh::mm::ss)
    Type: String
    AllowedValues:
         - "04:00:00"
         - "12:00:00"
         - "24:00:00"
         - "48:00:00"
         - "UNLIMITED"
    Default: "12:00:00"

  ComputeInstanceRetentionTime:
    Description: Duration (minutes) after a node becomes idle before it is terminated.
    Type: Number
    AllowedValues:
         - 10
         - 60
         - 120
         - 240
    Default: 120

  KeyName:
    Description: EC2 SSH KeyPair to login to the head node
    Type: AWS::EC2::KeyPair::KeyName

  HeadNodeSubnetId:
    Description: Subnet ID where the head node will launch
    Type: AWS::EC2::Subnet::Id

  ComputeSubnetIds:
    Description: Subnet IDs where compute nodes will launch. This should include at least the head node subnet.
    Type: List<AWS::EC2::Subnet::Id>

  OS:
    Type: String
    Default: alinux2
    AllowedValues:
      - alinux2
      - centos7
      - ubuntu1804
      - ubuntu2004
    Description: Enter alinux2, centos7, ubuntu1804 or ubuntu2004. Default is centos7.

  EfsFilesystemId:
    Description: ID for persistent EFS filesystem
    Type: String

  AdDomainName:
    Type: String
    Default: corp.pcluster.com

  AdDomainAddr:
    Type: String

  AdPasswordSecretArn:
    Type: String

  AdDomainReadOnlyUser:
    Type: String
    Default: cn=ReadOnlyUser,ou=Users,ou=CORP,dc=corp,dc=pcluster,dc=com

Resources:

  PclusterClusterProvider:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - https://${AWS::Region}-aws-parallelcluster.s3.${AWS::Region}.${AWS::URLSuffix}/parallelcluster/${Version}/templates/custom_resource/cluster.yaml
        - { Version: !Ref ParallelClusterVersion }
      TimeoutInMinutes: 10

  PclusterCluster:
    Type: Custom::PclusterCluster
    Properties:
      ServiceToken: !GetAtt [ PclusterClusterProvider , Outputs.ServiceToken ]
      ClusterName: !Sub 'c-${AWS::StackName}'
      ClusterConfiguration:
        Image:
          Os: !Ref OS
        HeadNode:
          InstanceType: c5.24xlarge
          Networking:
            SubnetId: !Ref HeadNodeSubnetId
          Ssh:
            KeyName: !Ref KeyName
          Iam:
            AdditionalIamPolicies:
            - Policy: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
          LocalStorage:
            RootVolume:
              Size: 256
              DeleteOnTermination: false
          CustomActions:
            OnNodeConfigured:
              Sequence:
                - Script: https://raw.githubusercontent.com/spack/spack-configs/main/AWS/parallelcluster/postinstall.sh
        Scheduling:
          Scheduler: slurm
          SlurmSettings:
            ScaledownIdletime: !Ref ComputeInstanceRetentionTime
            QueueUpdateStrategy: DRAIN
          SlurmQueues:
          - Name: normal
            CustomSlurmSettings:
              MaxTime: !Ref MaximumJobDuration
            ComputeResources:
            - Name: cr1
              Instances:
                - InstanceType: c5.24xlarge
                - InstanceType: m5.24xlarge
                - InstanceType: r5.24xlarge
              MinCount: 0
              MaxCount: !Ref ComputeInstanceMax
            Networking:
              SubnetIds: !Ref ComputeSubnetIds
          - Name: gpu
            CustomSlurmSettings:
              MaxTime: !Ref MaximumJobDuration
            ComputeResources:
            - Name: gr1
              Instances:
              - InstanceType: g5.4xlarge
              MinCount: 0
              MaxCount: !Ref GpuComputeInstanceMax
            Networking:
              SubnetIds: !Ref ComputeSubnetIds
        SharedStorage:
          - Name: Efs0
            StorageType: Efs
            MountDir: /shared/efs/apps
          - Name: Efs1
            StorageType: Efs
            MountDir: /shared/efs/data
            EfsSettings:
              FileSystemId: !Ref EfsFilesystemId
        DirectoryService:
          DomainName: !Ref AdDomainName
          DomainAddr: !Ref AdDomainAddr
          PasswordSecretArn: !Ref AdPasswordSecretArn
          DomainReadOnlyUser: !Ref AdDomainReadOnlyUser
          GenerateSshKeysForUsers: true
          AdditionalSssdConfigs:
            ldap_auth_disable_tls_never_use_in_production: True
            cache_credentials: false
            override_homedir: !Join ["/", ["/shared/efs", !Sub "c-${AWS::StackName}", "data/home/%u"]]
            # override_homedir: /shared/efs/data/home/%u
        Monitoring:
          DetailedMonitoring: true


Outputs:
  HeadNodeIp:
    Description: The Public IP address of the HeadNode
    Value: !GetAtt [ PclusterCluster, headNode.publicIpAddress ]
  ValidationMessages:
    Description: Any warnings from cluster create or update operations.
    Value: !GetAtt PclusterCluster.validationMessages

